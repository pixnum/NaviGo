<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NaviGo - Smart GPS Navigation</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='30' fill='black'/><circle cx='32' cy='32' r='12' fill='white'/></svg>">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}
html,body{height:100%;width:100%;background:#f0f0f0;color:#222;overflow:auto;}
body.dark{background:#121212;color:#f0f0f0;}
.container{width:100%;max-width:500px;margin:0 auto;display:flex;flex-direction:column;border:2px solid #ccc;border-radius:16px;position:relative;background:#fff;overflow:visible;box-shadow:0 6px 20px rgba(0,0,0,.15);}
body.dark .container{background:#1e1e1e;border-color:#555;}
.header {position:sticky;top:0;width:100%;display:flex;justify-content:center;align-items:center;background:#fff;z-index:1000;padding:0.5rem 0;}
body.dark .header{background:#1e1e1e;}
.header-center {display:flex;flex-direction:row;align-items:center;justify-content:center;gap:0.5rem;}
.app-icon {font-size:1.5rem;}
.app-title {font-size:1.5rem;margin:0;}
#toggleDark {position:absolute;top:10px;right:10px;width:45px;height:45px;border-radius:50%;border:2px solid #ccc;display:flex;justify-content:center;align-items:center;font-weight:bold;font-size:1.3rem;background:#fff;color:#222;cursor:pointer;z-index:1001;transition:.3s;}
body.dark #toggleDark {background:#333;color:#fff;border-color:#666;}
#map{margin-top:0;width:100%;height:400px;position:relative;}
.control-panel{width:100%;padding:0.5rem 1rem;display:flex;flex-direction:column;gap:0.5rem;overflow:auto;}
.row{display:flex;flex-direction:row;justify-content:space-between;gap:0.5rem;flex-wrap:wrap;}
.row input, .row button, .row select{flex:1 1 48%;min-width:0;padding:0.5rem 0.7rem;border-radius:10px;border:1px solid #ccc;font-size:0.95rem;}
.row button{background:#007bff;color:#fff;border:none;cursor:pointer;transition:.3s;}
.row button:hover{opacity:.85;}
#status,p{font-size:0.85rem;word-wrap:break-word;}
.compass{font-weight:bold;}
#calibrationHint{color:#d9534f;font-weight:bold;display:none;}
#publicTransport,#trafficAlerts,#poiList{font-size:0.85rem;margin-top:0.3rem;max-height:100px;overflow-y:auto;}
footer{width:100%;text-align:center;padding:0.5rem 0;font-size:0.8rem;color:#888;border-top:1px solid #ccc;position:sticky;bottom:0;background:#fff;z-index:999;}
body.dark footer{color:#aaa;border-color:#555;background:#1e1e1e;}
#zoomControls{position:absolute;top:60px;right:10px;display:flex;flex-direction:column;gap:5px;z-index:1002;}
#zoomControls button{width:35px;height:35px;border-radius:8px;border:none;background:#007bff;color:#fff;font-weight:bold;cursor:pointer;}
@media(max-width:500px){#map{height:300px;} .app-title{font-size:1.3rem;} .app-icon{font-size:1.3rem;}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-center">
      <span class="app-icon">üß≠</span>
      <h1 class="app-title">NaviGo</h1>
    </div>
    <div id="toggleDark">üåì</div>
  </div>

  <div id="zoomControls">
    <button id="zoomIn">+</button>
    <button id="zoomOut">-</button>
  </div>

  <div id="map"></div>

  <div class="control-panel">
    <p id="status">Click "Start Tracking" to begin</p>
    <p id="latitude"></p>
    <p id="longitude"></p>
    <p id="altitude"></p>
    <p id="speed"></p>
    <p id="accuracy"></p>
    <p class="compass" id="compass">Compass: --¬∞ (--)</p>
    <p id="calibrationHint">‚ö†Ô∏è Move your device in a figure-8 to calibrate the compass</p>
    <p id="street">Street: --</p>

    <div class="row">
      <button id="getLocation">Start Tracking</button>
      <button id="sos">Emergency SOS</button>
    </div>

    <div class="row">
      <input type="text" id="destination" placeholder="Enter destination"/>
      <button id="navigateBtn">Navigate</button>
    </div>

    <div class="row">
      <button id="addBookmark">Add Bookmark</button>
      <button id="clearMarkers">Clear Map</button>
    </div>

    <div class="row">
      <select id="mode">
        <option value="driving-car">Driving</option>
        <option value="cycling-regular">Cycling</option>
        <option value="foot-walking">Walking</option>
      </select>
    </div>

    <div class="row">
      <button id="batterySaverBtn">Battery Saver: OFF</button>
    </div>

    <div class="row">
      <button id="rideShareBtn">Ride-Sharing</button>
      <button id="wearableSyncBtn">Sync to Wearable</button>
    </div>

    <div class="row">
      <button id="loadPOIs">Load Nearby POIs</button>
      <button id="loadTraffic">Load Traffic Alerts</button>
      <button id="loadPublicTransport">Load Public Transport & ETA</button>
    </div>

    <div id="publicTransport"></div>
    <div id="trafficAlerts"></div>
    <div id="poiList"></div>
    <div class="bookmarks" id="bookmarkList"></div>
  </div>
  <footer>¬© Manik Roy 2025 | All Rights Reserved</footer>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ===================== Map & Tracking =====================
let map=L.map('map').setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
let marker=null,routeLine=L.polyline([], {color:'blue'}).addTo(map);
let watchId=null,previousPos=null,totalDistance=0,destinationPos=null;
let bookmarks=JSON.parse(localStorage.getItem('bookmarks')||"[]");

// Elements
const latElem=document.getElementById('latitude'), lonElem=document.getElementById('longitude'),
altElem=document.getElementById('altitude'), speedElem=document.getElementById('speed'),
accuracyElem=document.getElementById('accuracy'), compassElem=document.getElementById('compass'),
streetElem=document.getElementById('street'), status=document.getElementById('status'),
getLocationBtn=document.getElementById('getLocation'), toggleDarkBtn=document.getElementById('toggleDark'),
destinationInput=document.getElementById('destination'), navigateBtn=document.getElementById('navigateBtn'),
addBookmarkBtn=document.getElementById('addBookmark'), clearMarkersBtn=document.getElementById('clearMarkers'),
sosBtn=document.getElementById('sos'), bookmarkList=document.getElementById('bookmarkList'),
calibrationHint=document.getElementById('calibrationHint'), batteryBtn=document.getElementById('batterySaverBtn'),
rideShareBtn=document.getElementById('rideShareBtn'), wearableBtn=document.getElementById('wearableSyncBtn'),
publicTransportDiv=document.getElementById('publicTransport'),
trafficAlertsDiv=document.getElementById('trafficAlerts'),
poiListDiv=document.getElementById('poiList'),
loadPOIsBtn=document.getElementById('loadPOIs'),
loadTrafficBtn=document.getElementById('loadTraffic'),
loadPublicTransportBtn=document.getElementById('loadPublicTransport');

let batterySaver=false;
let gpsOptions={enableHighAccuracy:true,maximumAge:0,timeout:10000};
let lastSpeakTime=0,lastDistance=null;

// ===================== Dark Mode =====================
toggleDarkBtn.addEventListener('click',()=>{
  document.body.classList.toggle('dark');
  map.getContainer().style.filter=document.body.classList.contains('dark')?'invert(90%) hue-rotate(180deg)':'';
});

// ===================== Zoom Controls =====================
document.getElementById('zoomIn').addEventListener('click',()=>{map.zoomIn();});
document.getElementById('zoomOut').addEventListener('click',()=>{map.zoomOut();});

// ===================== Compass =====================
function getDirectionName(deg){const dirs=['N','NE','E','SE','S','SW','W','NW'];return dirs[Math.round(deg/45)%8];}
let compassHeading=0,lastHeading=null,unstableCount=0;
function handleOrientation(event){
  let alpha=event.alpha;
  if(event.absolute && alpha!==null){
    compassHeading=360-alpha;
    compassElem.textContent=`Compass: ${compassHeading.toFixed(0)}¬∞ (${getDirectionName(compassHeading)})`;
    if(lastHeading!==null && Math.abs(compassHeading-lastHeading)>20){unstableCount++;}else{unstableCount=0;}
    lastHeading=compassHeading;
    calibrationHint.style.display=(unstableCount>=3)?'block':'none';
  }
}
function enableCompass(){
  if(typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')window.addEventListener('deviceorientationabsolute',handleOrientation,true);}).catch(console.error);
  } else{window.addEventListener('deviceorientationabsolute',handleOrientation,true);}
}

// ===================== Distance =====================
function calcDistance(lat1,lon1,lat2,lon2){const R=6371e3,œÜ1=lat1*Math.PI/180,œÜ2=lat2*Math.PI/180,ŒîœÜ=(lat2-lat1)*Math.PI/180,ŒîŒª=(lon2-lon1)*Math.PI/180;const a=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c;}
async function updateStreetName(lat,lon){try{let res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);let data=await res.json();streetElem.textContent=`Street: ${data.address.road||'--'}`;}catch(e){streetElem.textContent='Street: --';}}

// ===================== Voice Guidance =====================
function speakDistance(lat1,lon1,lat2,lon2){
  if(!window.speechSynthesis)return;
  const distanceKm=calcDistance(lat1,lon1,lat2,lon2)/1000;
  if(lastDistance!==null&&Math.abs(distanceKm-lastDistance)<0.05)return;
  lastDistance=distanceKm;
  const now=Date.now();
  if(now-lastSpeakTime<3000)return;
  lastSpeakTime=now;
  window.speechSynthesis.cancel();
  const msg=new SpeechSynthesisUtterance(`You are ${distanceKm.toFixed(1)} kilometers from your destination`);
  msg.lang='en-US';window.speechSynthesis.speak(msg);
}

// ===================== Battery Saver =====================
batteryBtn.addEventListener('click',()=>{
  batterySaver=!batterySaver;
  if(batterySaver){gpsOptions.enableHighAccuracy=false;gpsOptions.maximumAge=30000;batteryBtn.textContent='Battery Saver: ON';}
  else{gpsOptions.enableHighAccuracy=true;gpsOptions.maximumAge=0;batteryBtn.textContent='Battery Saver: OFF';}
  if(watchId) navigator.geolocation.clearWatch(watchId);
  startTracking();
});

// ===================== Tracking =====================
function startTracking(){
  if(!navigator.geolocation){alert("Geolocation not supported");status.textContent="Geolocation not supported";return;}
  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(
    function success(pos){
      if(!pos||!pos.coords)return;
      const lat=pos.coords.latitude,lon=pos.coords.longitude;
      const alt=pos.coords.altitude||0,speed=pos.coords.speed||0,accuracy=pos.coords.accuracy||0;
      status.textContent="Tracking location‚Ä¶";
      latElem.textContent=`Latitude: ${lat.toFixed(6)}`;
      lonElem.textContent=`Longitude: ${lon.toFixed(6)}`;
      altElem.textContent=`Altitude: ${alt.toFixed(2)} m`;
      speedElem.textContent=`Speed: ${(speed*3.6).toFixed(2)} km/h`;
      accuracyElem.textContent=`GPS Accuracy: ${accuracy} m`;
      if(marker) marker.setLatLng([lat,lon]);
      else marker=L.marker([lat,lon]).addTo(map).bindPopup("You are here").openPopup();
      map.setView([lat,lon],15);
      if(previousPos) totalDistance+=calcDistance(previousPos.lat,previousPos.lon,lat,lon);
      previousPos={lat,lon};
      routeLine.addLatLng([lat,lon]);
      updateStreetName(lat,lon);
      if(destinationPos)speakDistance(lat,lon,destinationPos.lat,destinationPos.lon);
    },
    function error(err){console.error(err);status.textContent="Error tracking location";},
    gpsOptions
  );
}

getLocationBtn.addEventListener('click',()=>{startTracking(); enableCompass();});

// ===================== Navigation =====================
navigateBtn.addEventListener('click',()=>{
  const dest=destinationInput.value.trim();
  if(!dest){alert("Enter destination");return;}
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dest)}`)
  .then(r=>r.json()).then(data=>{
    if(!data||!data.length){alert("Destination not found");return;}
    const dlat=parseFloat(data[0].lat),dlon=parseFloat(data[0].lon);
    destinationPos={lat:dlat,lon:dlon};
    L.marker([dlat,dlon],{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[30,30]})}).addTo(map).bindPopup("Destination").openPopup();
  });
});

// ===================== Bookmarks =====================
function renderBookmarks(){bookmarkList.innerHTML='';bookmarks.forEach(b=>{const div=document.createElement('div');div.textContent=`${b.name}: ${b.lat.toFixed(6)}, ${b.lon.toFixed(6)}`;bookmarkList.appendChild(div);});}
addBookmarkBtn.addEventListener('click',()=>{
  if(!previousPos){alert("No location to bookmark");return;}
  const name=prompt("Enter bookmark name")||`Bookmark ${bookmarks.length+1}`;
  bookmarks.push({name,lat:previousPos.lat,lon:previousPos.lon});
  localStorage.setItem('bookmarks',JSON.stringify(bookmarks));
  renderBookmarks();
});
clearMarkersBtn.addEventListener('click',()=>{routeLine.setLatLng([]);map.eachLayer(l=>{if(l instanceof L.Marker&&!l._icon.classList.contains('leaflet-marker-icon'))map.removeLayer(l);});});

// ===================== SOS =====================
sosBtn.addEventListener('click',()=>{alert("SOS activated! Sending your location...");console.log(previousPos);});

// ===================== POIs =====================
loadPOIsBtn.addEventListener('click',async()=>{
  poiListDiv.textContent="Loading POIs...";
  try{
    const res=await fetch(`https://overpass-api.de/api/interpreter?data=[out:json];node(around:500,${previousPos.lat},${previousPos.lon})[amenity];out;`);
    const data=await res.json();
    poiListDiv.textContent="";
    data.elements.forEach(e=>{
      const p=document.createElement('div');
      p.textContent=e.tags.name||e.tags.amenity||'Unnamed POI';
      poiListDiv.appendChild(p);
    });
  }catch(e){poiListDiv.textContent="No POIs found";}
});

// ===================== Traffic Alerts =====================
loadTrafficBtn.addEventListener('click',async()=>{
  trafficAlertsDiv.textContent="Loading traffic...";
  try{
    const res=await fetch(`https://overpass-api.de/api/interpreter?data=[out:json];node(around:500,${previousPos.lat},${previousPos.lon})[highway=traffic_signals];out;`);
    const data=await res.json();
    trafficAlertsDiv.textContent="";
    data.elements.forEach(e=>{
      const p=document.createElement('div');
      p.textContent=`Traffic signal nearby: ${e.tags.name||'Unnamed'}`;
      trafficAlertsDiv.appendChild(p);
    });
  }catch(e){trafficAlertsDiv.textContent="No traffic alerts found";}
});

// ===================== Public Transport & ETA =====================
loadPublicTransportBtn.addEventListener('click',async()=>{
  publicTransportDiv.textContent="Loading nearby public transport...";
  try{
    let res=await fetch(`https://overpass-api.de/api/interpreter?data=[out:json];node(around:500,${previousPos.lat},${previousPos.lon})[public_transport=platform];out;`);
    let data=await res.json();publicTransportDiv.textContent="";
    data.elements.forEach(e=>{
      let dMeters=calcDistance(previousPos.lat,previousPos.lon,e.lat,e.lon);
      let etaMin=(dMeters/80).toFixed(0);
      const p=document.createElement('div');
      p.textContent=`Stop: ${e.tags.name||'Unnamed'}, ETA: ~${etaMin} min`;
      publicTransportDiv.appendChild(p);
    });
  }catch(e){publicTransportDiv.textContent="No nearby public transport stops";}
});

// ===================== Ride-Sharing & Wearable =====================
rideShareBtn.addEventListener('click',()=>{alert("Ride-sharing integration (optional, demo)");});
wearableBtn.addEventListener('click',()=>{alert("Wearable sync (optional, demo)");});

// ===================== Initialize =====================
renderBookmarks();
</script>
</body>
</html>

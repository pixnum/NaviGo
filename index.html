<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NaviGo - Smart GPS Navigation</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='30' fill='black'/><circle cx='32' cy='32' r='12' fill='white'/></svg>">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}
html,body{height:100%;width:100%;background:#f0f0f0;color:#222;display:flex;justify-content:center;align-items:flex-start;overflow:hidden;}
body.dark{background:#121212;color:#f0f0f0;}
.container{width:100%;max-width:500px;margin:0 auto;display:flex;flex-direction:column;align-items:center;border:2px solid #ccc;border-radius:16px;position:relative;background:#fff;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,.15);}
body.dark .container{background:#1e1e1e;border-color:#555;}
h1{font-size:1.5rem;margin:1rem 0 0.5rem 0;text-align:left;display:flex;align-items:center;gap:0.5rem;z-index:1;}
#toggleDark{position:absolute; top:1rem; right:1rem; width:45px; height:45px; border-radius:50%; border:2px solid #ccc; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:1.3rem; background:#fff; color:#222; cursor:pointer; z-index:999; transition:.3s;}
body.dark #toggleDark{background:#333; color:#fff; border-color:#666;}
#map{width:100%; height:400px; max-height:400px;}
.control-panel{width:100%; padding:0.5rem 1rem; display:flex; flex-direction:column; gap:0.5rem;}
.row{display:flex; flex-direction:row; justify-content:space-between; gap:0.5rem; flex-wrap:wrap;}
.row input, .row button, .row select{flex:1 1 48%; min-width:0; padding:0.5rem 0.7rem; border-radius:10px; border:1px solid #ccc; font-size:0.95rem;}
.row button{background:#007bff;color:#fff;border:none;cursor:pointer;transition:.3s;}
.row button:hover{opacity:.85;}
#status,p{font-size:0.85rem; word-wrap:break-word;}
.compass{font-weight:bold;}
footer{width:100%;text-align:center;padding:0.5rem 0;font-size:0.8rem;color:#888;border-top:1px solid #ccc;}
body.dark footer{color:#aaa;border-color:#555;}
.leaflet-control-zoom {top:50px !important; right:10px !important;}
@media(max-width:500px){#map{height:350px;}h1{font-size:1.3rem;}}
</style>
</head>
<body>
<div class="container">
<div id="toggleDark">ðŸŒ“</div>
<h1>ðŸ§­ NaviGo</h1>

<div class="control-panel">
<p id="status">Click "Start Tracking" to begin</p>
<p id="latitude"></p>
<p id="longitude"></p>
<p id="altitude"></p>
<p id="speed"></p>
<p id="accuracy"></p>
<p class="compass" id="compass">Compass: --Â° (--)</p>
<p id="street">Street: --</p>

<div class="row">
<button id="getLocation">Start Tracking</button>
<button id="sos">Emergency SOS</button>
</div>

<div class="row">
<input type="text" id="destination" placeholder="Enter destination"/>
<button id="navigateBtn">Navigate</button>
</div>

<div class="row">
<button id="addBookmark">Add Bookmark</button>
<button id="clearMarkers">Clear Map</button>
</div>

<div class="row">
<select id="mode">
<option value="driving-car">Driving</option>
<option value="cycling-regular">Cycling</option>
<option value="foot-walking">Walking</option>
</select>
</div>

<div class="bookmarks" id="bookmarkList"></div>
</div>

<div id="map"></div>
<footer>Â© Manik Roy 2025 | All Rights Reserved</footer>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Map setup
let map = L.map('map').setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
let marker, routeLine=L.polyline([], {color:'blue'}).addTo(map);
let watchId = null, previousPos=null, totalDistance=0, destinationPos=null;
let bookmarks = JSON.parse(localStorage.getItem('bookmarks')||"[]");

// Elements
const latElem = document.getElementById('latitude'), lonElem = document.getElementById('longitude'),
altElem = document.getElementById('altitude'), speedElem = document.getElementById('speed'),
accuracyElem = document.getElementById('accuracy'), compassElem = document.getElementById('compass'),
streetElem = document.getElementById('street'), status = document.getElementById('status'),
getLocationBtn = document.getElementById('getLocation'), toggleDarkBtn = document.getElementById('toggleDark'),
destinationInput = document.getElementById('destination'), navigateBtn = document.getElementById('navigateBtn'),
addBookmarkBtn = document.getElementById('addBookmark'), clearMarkersBtn = document.getElementById('clearMarkers'),
sosBtn = document.getElementById('sos'), bookmarkList = document.getElementById('bookmarkList');

// Dark mode toggle
toggleDarkBtn.addEventListener('click',()=>{document.body.classList.toggle('dark');map.getContainer().style.filter=document.body.classList.contains('dark')?'invert(90%) hue-rotate(180deg)':'';});

// Compass with cardinal directions
function getDirectionName(deg){
  const directions = ['N','NE','E','SE','S','SW','W','NW'];
  return directions[Math.round(deg/45)%8];
}
if(window.DeviceOrientationEvent){
  if(typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(response=>{
      if(response==='granted'){console.log('Orientation permission granted');}
    }).catch(console.error);
  }
  window.addEventListener('deviceorientationabsolute', event => {
    if(event.absolute && event.alpha !== null){
      let heading = event.alpha;
      compassElem.textContent = `Compass: ${heading.toFixed(0)}Â° (${getDirectionName(heading)})`;
    }
  }, true);
}

// Distance calculation
function calcDistance(lat1,lon1,lat2,lon2){
  const R=6371e3, Ï†1=lat1*Math.PI/180, Ï†2=lat2*Math.PI/180, Î”Ï†=(lat2-lat1)*Math.PI/180, Î”Î»=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(Î”Ï†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

// Update street name
function updateStreetName(lat,lon){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
    .then(res=>res.json()).then(data=>{streetElem.textContent=`Street: ${data.address.road||'--'}`;}).catch(()=>{streetElem.textContent='Street: --';});
}

// Enhanced Voice guidance
let lastSpeakTime = 0;
let lastDistance = null;
function speakDistance(lat1, lon1, lat2, lon2){
  if(!window.speechSynthesis) return;
  const distanceKm = calcDistance(lat1, lon1, lat2, lon2)/1000;
  if(lastDistance !== null && Math.abs(distanceKm - lastDistance) < 0.05) return; // only if moved â‰¥50m
  lastDistance = distanceKm;
  const now = Date.now();
  if(now - lastSpeakTime < 3000) return; // min 3s interval
  lastSpeakTime = now;
  window.speechSynthesis.cancel(); // cancel previous speech
  const msg = new SpeechSynthesisUtterance(`You are ${distanceKm.toFixed(1)} kilometers from your destination`);
  msg.lang = 'en-US';
  window.speechSynthesis.speak(msg);
}

// Start Tracking
function startTracking() {
  if(!navigator.geolocation){alert("Geolocation not supported");status.textContent="Geolocation not supported";return;}
  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(
    function success(pos){
      if(!pos||!pos.coords) return;
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      const alt=pos.coords.altitude||0, speed=pos.coords.speed||0, accuracy=pos.coords.accuracy||0;
      status.textContent="Tracking locationâ€¦";
      latElem.textContent=`Latitude: ${lat.toFixed(6)}`;
      lonElem.textContent=`Longitude: ${lon.toFixed(6)}`;
      altElem.textContent=`Altitude: ${alt.toFixed(2)} m`;
      speedElem.textContent=`Speed: ${(speed*3.6).toFixed(2)} km/h`;
      accuracyElem.textContent=`GPS Accuracy: ${accuracy} m`;
      if(marker) marker.setLatLng([lat,lon]);
      else marker=L.marker([lat,lon]).addTo(map).bindPopup("You are here").openPopup();
      map.setView([lat,lon],15);
      if(previousPos) totalDistance+=calcDistance(previousPos.lat,previousPos.lon,lat,lon);
      previousPos={lat,lon};
      updateStreetName(lat,lon);
      updateRoute(lat,lon);
    },
    function error(err){
      switch(err.code){
        case err.PERMISSION_DENIED: alert("Location permission denied");status.textContent="Permission denied"; break;
        case err.POSITION_UNAVAILABLE: alert("Location unavailable");status.textContent="Location unavailable"; break;
        case err.TIMEOUT: alert("Location request timed out");status.textContent="Timeout"; break;
        default: alert("Error: "+err.message);status.textContent="Error getting location";
      }
    },
    {enableHighAccuracy:true,maximumAge:0,timeout:10000}
  );
}
getLocationBtn.addEventListener('click',startTracking);

// Update route
function updateRoute(lat,lon){
  if(!destinationPos) return;
  routeLine.setLatLng([[lat,lon],[destinationPos.lat,destinationPos.lon]]);
  const dist=calcDistance(lat,lon,destinationPos.lat,destinationPos.lon);
  status.textContent=`Distance to destination: ${(dist/1000).toFixed(3)} km`;
  speakDistance(lat,lon,destinationPos.lat,destinationPos.lon);
}

// Navigate to destination
navigateBtn.addEventListener('click',()=>{
  const dest=destinationInput.value.trim();
  if(!dest){alert('Enter destination');return;}
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dest)}&limit=1`)
    .then(res=>res.json())
    .then(data=>{
      if(data.length>0){
        destinationPos={lat:parseFloat(data[0].lat),lon:parseFloat(data[0].lon)};
        L.marker([destinationPos.lat,destinationPos.lon]).addTo(map).bindPopup(dest).openPopup();
        if(previousPos) updateRoute(previousPos.lat,previousPos.lon);
      } else alert('Destination not found');
    });
});

// Bookmarks
function renderBookmarks(){bookmarkList.innerHTML=bookmarks.map((b,i)=>`<div>${b.name} <button onclick="goToBookmark(${i})">Go</button> <button onclick="deleteBookmark(${i})">Delete</button></div>`).join('');}
function goToBookmark(i){const b=bookmarks[i]; map.setView([b.lat,b.lon],15); if(marker) marker.setLatLng([b.lat,b.lon]); else marker=L.marker([b.lat,b.lon]).addTo(map).bindPopup(b.name).openPopup();}
function deleteBookmark(i){bookmarks.splice(i,1); localStorage.setItem('bookmarks',JSON.stringify(bookmarks)); renderBookmarks();}
renderBookmarks();
addBookmarkBtn.addEventListener('click',()=>{
  if(!previousPos){alert('No location to bookmark');return;}
  const name=prompt('Enter bookmark name','My Location'); if(!name) return;
  bookmarks.push({name,lat:previousPos.lat,lon:previousPos.lon}); localStorage.setItem('bookmarks',JSON.stringify(bookmarks)); renderBookmarks();
});

// SOS
sosBtn.addEventListener('click',()=>{
  if(!previousPos){alert('No location');return;}
  const link=`mailto:?subject=Emergency!&body=My location: https://www.google.com/maps?q=${previousPos.lat},${previousPos.lon}`;
  window.location.href=link;
});

// Clear markers
clearMarkersBtn.addEventListener('click',()=>{map.eachLayer(l=>{if(l instanceof L.Marker && l!==marker) map.removeLayer(l);}); routeLine.setLatLng([]);});

// Map scale
L.control.scale().addTo(map);
</script>
</body>
</html>
